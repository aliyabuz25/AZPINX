<%- include('partials/header') %>

 <div class="product-page-container">
 <div class="breadcrumb">
 <a href="/">Ana Səhifə</a> <i class="ri-arrow-right-s-line"></i>
 <span>
 <%= product.category %>
 </span> <i class="ri-arrow-right-s-line"></i>
 <span>
 <%= product.name %>
 </span>
 </div>

 <div class="product-detail-grid">
 <div class="product-detail-left">
 <div class="product-gallery">
 <% if (product.image && !String(product.image).includes('placeholder')) { %>
 <img src="<%= product.image %>" alt="<%= product.name %>" id="mainProdImage">
 <% } else { %>
 <div class="no-image-placeholder">
 <i class="ri-gamepad-line"></i>
 <span>Resim yok</span>
 </div>
 <% } %>
 <% if (product.badge) { %>
 <div class="badge-float">
 <%= product.badge %>
 </div>
 <% } %>
 </div>
 </div>

 <div class="product-detail-right">
 <span class="p-cat-tag">
 <%= product.category %>
 </span>
 <h1 class="p-title">
 <%= product.name %>
 </h1>

 <div class="p-meta">
 <span>Stokda</span>
 <span>Ani teslimat</span>
 </div>

 <div class="p-price-card">
 <div class="p-prices">
 <% if (product.oldPrice) { %>
 <span class="p-old">
 <%= product.oldPrice.toFixed(2) %> AZN
 </span>
 <% } %>
 <span class="p-current">
 <%= product.price.toFixed(2) %> AZN
 </span>
 </div>

 <% if (requiresPlayerId) { %>
 <div class="mb-3">
 <label for="player_id" class="small text-muted d-block mb-2">Player ID</label>
 <div class="d-flex align-items-center">
 <input type="text" id="player_id" class="form-control mr-2" placeholder="5124018318">
 <button class="btn btn-outline-dark" id="btnCheckID" type="button">Yoxla</button>
 </div>
 <div id="idStatus" class="small mt-2 text-muted"></div>
 <input type="hidden" id="player_nickname" value="">
 </div>

 <script>
 const btnCheckId = document.getElementById('btnCheckID');
 const idInput = document.getElementById('player_id');
 const hiddenNickname = document.getElementById('player_nickname');
 const statusDiv = document.getElementById('idStatus');

 async function checkPlayerId() {
 const id = (idInput.value || '').trim();
 if (!id) {
 statusDiv.textContent = 'Player ID daxil edin.';
 statusDiv.className = 'small mt-2 text-danger';
 return;
 }

 btnCheckId.disabled = true;
 btnCheckId.textContent = '...';
 statusDiv.textContent = 'Yoxlanılır...';
 statusDiv.className = 'small mt-2 text-muted';

 const fallbackNote = 'ID: ' + id;
 try {
 const res = await fetch('/api/pubg-check?player_id=' + id);
 const data = await res.json();
 if (data.success) {
 statusDiv.textContent = data.nickname;
 statusDiv.className = 'small mt-2 text-success';
 hiddenNickname.value = data.nickname || fallbackNote;
 } else {
 statusDiv.textContent = 'ID təsdiqlənmədi, ID ilə davam ediləcək.';
 statusDiv.className = 'small mt-2 text-warning';
 hiddenNickname.value = fallbackNote;
 }
 } catch (e) {
 statusDiv.textContent = 'Xəta oldu, ID ilə davam ediləcək.';
 statusDiv.className = 'small mt-2 text-warning';
 hiddenNickname.value = fallbackNote;
 }

 btnCheckId.disabled = false;
 btnCheckId.textContent = 'Yoxla';
 }

 btnCheckId.addEventListener('click', checkPlayerId);
 idInput.addEventListener('keydown', (e) => {
 if (e.key === 'Enter') {
 e.preventDefault();
 checkPlayerId();
 }
 });
 idInput.addEventListener('input', function () {
 const id = this.value.trim();
 hiddenNickname.value = id ? ('ID: ' + id) : '';
 statusDiv.textContent = '';
 });
 </script>
 <% } %>

 <div class="p-actions">
 <button class="btn btn-primary btn-large" id="btnAddToCart" onclick="handleAddToCart()"
 >
 Səbətə əlavə et
 </button>
 <button class="btn btn-outline wishlist-btn"
 onclick="toggleWishlist('<%= product.id %>', this)">
 <i class="ri-heart-line"></i>
 </button>
 </div>

 <script>
 function handleAddToCart() {
 const isPubg = "<%= requiresPlayerId ? 'true' : 'false' %>" === "true";
 let extra = {};
 if (isPubg) {
 const pid = (document.getElementById('player_id').value || '').trim();
 let pnick = (document.getElementById('player_nickname').value || '').trim();
 if (!pid) {
 Toastify({ text:"Zəhmət olmasa Player ID daxil edin.", backgroundColor:"#ef4444" }).showToast();
 return;
 }
 if (!pnick) pnick = 'ID: ' + pid;
 extra = { player_id: pid, player_nickname: pnick };
 }
 const productObj = {
 id: '<%= product.id %>',
 name: <%- JSON.stringify(product.name ||"") %>,
 price: <%= Number(product.price) || 0 %>,
 img: <%- JSON.stringify(product.image_path || product.image ||"") %>,
 ...extra
 };
 addToCartFromPage(productObj);
 }
 </script>
 </div>

 <div class="p-features">
 <div class="f-item">100% Orijinal Məhsul</div>
 <div class="f-item">7/24 Dəstək</div>
 <div class="f-item">Ani Teslimat</div>
 <div class="f-item">Təhlükəsiz Ödəniş</div>
 </div>

 <div class="p-description-box">
 <h4>Məhsul Haqqında</h4>
 <p>
 <%= product.description %>
 </p>
 </div>
 </div>
 </div>

 <% if (similarProducts && similarProducts.length> 0) { %>
 <section class="section-container" style="margin-top: 80px;">
 <div class="section-header">
 <h3>Oxşar Məhsullar</h3>
 </div>
 <div class="product-grid">
 <% similarProducts.forEach(prod=> { %>
 <%- include('partials/product_card', { product: prod }) %>
 <% }) %>
 </div>
 </section>
 <% } %>
 </div>

 <%- include('partials/footer') %>
