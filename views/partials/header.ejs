<!DOCTYPE html>
<html lang="az">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>
 <%= title %>
 </title>
 <% const seoTitle = (settings && settings.seo_meta_title) ? settings.seo_meta_title : 'AZPINX'; %>
 <% const seoDescription = (settings && settings.seo_meta_description) ? settings.seo_meta_description : 'AZPINX rəqəmsal məhsul platforması'; %>
 <% const seoKeywords = (settings && settings.seo_meta_keywords) ? settings.seo_meta_keywords : 'azpinx, oyun, pin'; %>
 <% const seoRobots = (settings && settings.seo_robots) ? settings.seo_robots : 'index,follow'; %>
 <meta name="description" content="<%= seoDescription %>">
 <meta name="keywords" content="<%= seoKeywords %>">
 <meta name="robots" content="<%= seoRobots %>">
 <meta property="og:site_name" content="AZPINX">
 <meta property="og:title" content="<%= seoTitle %>">
 <meta property="og:description" content="<%= seoDescription %>">
 <meta property="og:type" content="website">
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
 rel="stylesheet">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.6.0/fonts/remixicon.css">
 <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
 <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
 <link rel="stylesheet" href="/css/transition.css?v=20260216-4">
 <link rel="stylesheet" href="/css/style.css?v=20260216-7">
 <script src="/js/currency.js?v=20260217-1" defer></script>
 <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
</head>

<body>
 <div id="azpin-splash" aria-hidden="true">
 <div class="azpin-splash-inner">
 <img src="/images/comp-1_00000.png" alt="AZPINX" class="azpin-splash-logo">
 </div>
 </div>
 <% if (locals.error) { %>
 <script>
 window.addEventListener('load', () => {
 Toastify({
 text:"<%= error %>",
 duration: 3000,
 gravity:"top",
 position:"right",
 backgroundColor:"#ef4444",
 stopOnFocus: true
 }).showToast();
 });
 </script>
 <% } %>
 <% if (locals.success) { %>
 <script>
 window.addEventListener('load', () => {
 Toastify({
 text:"<%= success %>",
 duration: 3000,
 gravity:"top",
 position:"right",
 backgroundColor:"#10b981",
 stopOnFocus: true
 }).showToast();
 });
 </script>
 <% } %>
 <% if (locals.announcements && announcements.length> 0) { %>
 <div class="hub-msg-container">
 <div class="hub-msg-slider">
 <% announcements.forEach(msg=> { %>
 <div class="hub-msg-item hub-msg-<%= msg.type %>">
 <i class="ri-megaphone-line mr-2"></i>
 <strong>
 <%= msg.title %>:
 </strong>
 <span>
 <%= msg.message %>
 </span>
 </div>
 <% }) %>
 <!-- Duplicate for seamless loop if content is short -->
 <% announcements.forEach(msg=> { %>
 <div class="hub-msg-item hub-msg-<%= msg.type %>">
 <i class="ri-megaphone-line mr-2"></i>
 <strong>
 <%= msg.title %>:
 </strong>
 <span>
 <%= msg.message %>
 </span>
 </div>
 <% }) %>
 </div>
 </div>
 <% } %>
 <header>
 <div class="top-bar">
 <div class="top-bar-main">
 <a href="/" class="logo">
 <img src="/images/comp-1_00000.png" alt="AZPINX Logo" style="height: 85px;">
 </a>
 <button class="navbar-toggler topbar-toggler d-lg-none" type="button"
 data-toggle="collapse" data-target="#topbarActions"
 aria-controls="topbarActions" aria-expanded="false"
 aria-label="Toggle navigation">
 <i class="ri-menu-line"></i>
 </button>
 </div>
 <form action="/" method="GET" class="search-container">
 <i class="ri-search-line"></i>
 <input type="text" name="q" placeholder="Yüz minlərlə məhsul içində axtar..."
 value="<%= locals.searchQuery || '' %>">
 </form>
 <div class="collapse d-lg-flex topbar-actions-wrap" id="topbarActions">
 <div class="auth-buttons">
 <div class="currency-switcher" title="Currency">
 <i class="ri-exchange-dollar-line"></i>
 <select id="currencySelector" class="currency-select" aria-label="Currency selector">
 <option value="AZN">AZN</option>
 <option value="TRY">TRY</option>
 <option value="USD">USD</option>
 </select>
 </div>
 <% if (locals.user) { %>
 <div class="nav-balance-lite">
 <span class="js-currency-money" data-azn-value="<%= Number(user.balance || 0).toFixed(2) %>"><%= Number(user.balance || 0).toFixed(2) %> AZN</span>
 <button type="button" class="nav-balance-plus" id="openTopupModal" title="Balans artır">
 <i class="ri-add-line"></i>
 </button>
 </div>

 <!-- Wishlist -->
 <a href="/wishlist" class="nav-btn" title="İstəklər">
 <i class="ri-heart-line"></i>
 </a>

 <!-- Tickets -->
 <a href="/tickets" class="nav-btn" title="Dəstək">
 <i class="ri-customer-service-2-line"></i>
 </a>

 <!-- FAQ -->
 <a href="/faq" class="nav-btn" title="FAQ">
 <i class="ri-question-line"></i>
 </a>

 <!-- Profile -->
 <a href="/profile" class="nav-btn" title="Profil: <%= user.full_name %>">
 <i class="ri-user-3-line"></i>
 </a>

 <!-- Admin Access -->
 <% if (user.role==='admin' ) { %>
 <a href="/admin" class="nav-btn" title="Admin Panel"
 style="color: #f43f5e;">
 <i class="ri-shield-star-line"></i>
 </a>
 <% } else if (user.role==='reseller' ) { %>
 <a href="/reseller" class="nav-btn" title="Bayi Paneli"
 style="color: #22c55e;">
 <i class="ri-store-3-line"></i>
 </a>
 <% } %>

 <!-- Logout -->
 <a href="/logout" class="nav-btn" title="Çıxış">
 <i class="ri-logout-box-r-line"></i>
 </a>

 <% } else { %>
 <a href="/login" class="btn btn-outline"
 style="border-color: rgba(255,255,255,0.2); color:white;">Daxil
 ol</a>
 <a href="/register" class="btn btn-primary">Qeydiyyat</a>
 <% } %>

 <!-- Cart Trigger (Always Visible or adjust as needed) -->
 <div class="nav-btn" id="cartTrigger">
 <i class="ri-shopping-cart-2-line"></i>
 <span class="cart-count">0</span>
 </div>
 </div>
 </div>
 </div>
 </header>
 <% if (locals.user) { %>
 <div class="topup-modal" id="topupModal">
 <div class="topup-modal-card" data-no-currency-convert="1">
 <div class="topup-head">
 <h4>Balans artır</h4>
 <button type="button" id="closeTopupModal" class="topup-close"><i class="ri-close-line"></i></button>
 </div>

 <div class="topup-mode-tabs" id="topupModeTabs">
 <button type="button" class="topup-mode-btn active" data-mode="c2c">C2C (AZN)</button>
 <button type="button" class="topup-mode-btn" data-mode="tr">TR IBAN (TRY)</button>
 </div>
 <p class="topup-sub" id="topupSubText">Paket seçin, C2C ödənişi edin, dekont yükləyin. Admin təsdiqdən sonra balans artırılacaq.</p>

 <div class="topup-packages" id="topupPackages">
 <% [20,40,60,80,100,120,140,160].forEach(function(pkg){ %>
 <button type="button" class="topup-package-btn no-auto-currency" data-amount="<%= pkg %>" data-azn="<%= pkg %>"><%= pkg %> AZN</button>
 <% }) %>
 </div>
 <label for="topupAmountManual" id="topupAmountLabel" class="topup-input-label">Məbləğ (AZN)</label>
 <input type="number" id="topupAmountManual" class="topup-input mt-2" min="1" step="0.01" placeholder="və ya məbləği əl ilə daxil edin">
 <small class="topup-input-hint" id="topupAmountHint">TR IBAN seçiləndə daxil etdiyiniz TRY məbləği sistemdə avtomatik AZN-ə çevrilir.</small>

 <div class="topup-c2c-box topup-pay-box topup-pay-c2c">
 <div class="topup-bank-row"><span>Kart</span><strong><%= settings.bank_card || '0000 0000 0000 0000' %></strong></div>
 <div class="topup-bank-row"><span>Sahib</span><strong><%= settings.bank_holder || 'AZPINX ADMIN' %></strong></div>
 <div class="topup-bank-row"><span>Bank</span><strong><%= settings.bank_name || 'BANK' %></strong></div>
 </div>
 <div class="topup-c2c-box topup-pay-box topup-pay-tr" style="display:none;">
 <div class="topup-bank-row"><span>IBAN</span><strong><%= settings.tr_iban || 'TR00 0000 0000 0000 0000 0000 00' %></strong></div>
 <div class="topup-bank-row"><span>Sahib</span><strong><%= settings.tr_account_holder || 'ISIM SOYISIM' %></strong></div>
 <div class="topup-bank-row"><span>Banka</span><strong><%= settings.tr_bank_name || 'BANKA' %></strong></div>
 </div>
 <p class="topup-security-note"><i class="ri-shield-check-line"></i> Ödəniş məlumatları AES-256 və TLS ilə qorunan təhlükəsiz infrastrukturda emal olunur.</p>

 <div class="topup-form">
 <input type="text" id="topupSenderNameNav" class="topup-input" placeholder="Ad Soyad">
 <input type="file" id="topupReceiptNav" class="topup-input" accept="image/*">
 <button type="button" id="submitTopupNav" class="btn btn-primary btn-sm" style="width:100%;">Dekont göndər</button>
 </div>
 </div>
 </div>
 <% } %>

 <script>
(function () {
 const openBtn = document.getElementById('openTopupModal');
 const closeBtn = document.getElementById('closeTopupModal');
 const modal = document.getElementById('topupModal');
 const modeTabs = document.getElementById('topupModeTabs');
 const packageWrap = document.getElementById('topupPackages');
 const submitBtn = document.getElementById('submitTopupNav');
 const senderInput = document.getElementById('topupSenderNameNav');
 const receiptInput = document.getElementById('topupReceiptNav');
 const manualAmountInput = document.getElementById('topupAmountManual');
 const amountLabel = document.getElementById('topupAmountLabel');
 const amountHint = document.getElementById('topupAmountHint');
 const subText = document.getElementById('topupSubText');
 const c2cBox = modal ? modal.querySelector('.topup-pay-c2c') : null;
 const trBox = modal ? modal.querySelector('.topup-pay-tr') : null;
 if (!openBtn || !modal || !modeTabs || !packageWrap || !submitBtn || !senderInput || !receiptInput || !manualAmountInput || !amountLabel || !amountHint || !subText || !c2cBox || !trBox) return;

 let paymentMode = 'c2c';
 let selectedAmountAzn = 20;
 let fxRates = { AZN: 1, TRY: 21, USD: 0.588235 };

 const toNum = (value) => {
 const n = Number(String(value || '').replace(',', '.').trim());
 return Number.isFinite(n) ? n : 0;
 };

 const format2 = (value) => new Intl.NumberFormat(undefined, {
 minimumFractionDigits: 2,
 maximumFractionDigits: 2
 }).format(Number(value || 0));

 const getTryRate = () => {
 const r = Number(fxRates.TRY || 0);
 return (Number.isFinite(r) && r > 0) ? r : 21;
 };

 function displayedFromAzn(aznAmount) {
 return paymentMode === 'tr' ? (aznAmount * getTryRate()) : aznAmount;
 }

 function aznFromDisplayed(displayedAmount) {
 return paymentMode === 'tr' ? (displayedAmount / getTryRate()) : displayedAmount;
 }

 function updatePackageLabels() {
 packageWrap.querySelectorAll('.topup-package-btn').forEach((btn) => {
 const azn = toNum(btn.dataset.azn || btn.dataset.amount);
 const value = displayedFromAzn(azn);
 btn.textContent = paymentMode === 'tr'
 ? `${format2(value)} TRY`
 : `${format2(value)} AZN`;
 });
 }

 function syncManualFromSelected() {
 manualAmountInput.value = String(displayedFromAzn(selectedAmountAzn).toFixed(2));
 }

 function syncActivePackageFromAzn() {
 packageWrap.querySelectorAll('.topup-package-btn').forEach((btn) => {
 const azn = toNum(btn.dataset.azn || btn.dataset.amount);
 btn.classList.toggle('active', Math.abs(azn - selectedAmountAzn) < 0.0001);
 });
 }

 function setPaymentMode(nextMode) {
 paymentMode = nextMode === 'tr' ? 'tr' : 'c2c';
 modeTabs.querySelectorAll('.topup-mode-btn').forEach((btn) => {
 btn.classList.toggle('active', btn.dataset.mode === paymentMode);
 });
 c2cBox.style.display = paymentMode === 'c2c' ? 'block' : 'none';
 trBox.style.display = paymentMode === 'tr' ? 'block' : 'none';
 subText.textContent = paymentMode === 'tr'
 ? 'Paket seçin, TR IBAN köçürməsi edin, dekont yükləyin. Admin təsdiqdən sonra balans artırılacaq.'
 : 'Paket seçin, C2C ödənişi edin, dekont yükləyin. Admin təsdiqdən sonra balans artırılacaq.';
 amountLabel.textContent = paymentMode === 'tr' ? 'Məbləğ (TRY)' : 'Məbləğ (AZN)';
 amountHint.style.display = paymentMode === 'tr' ? 'block' : 'none';
 updatePackageLabels();
 syncManualFromSelected();
 syncActivePackageFromAzn();
 }

 modeTabs.addEventListener('click', (e) => {
 const btn = e.target.closest('.topup-mode-btn');
 if (!btn) return;
 setPaymentMode(btn.dataset.mode);
 });

 packageWrap.querySelectorAll('.topup-package-btn').forEach((btn) => {
 const azn = toNum(btn.dataset.azn || btn.dataset.amount);
 if (Math.abs(azn - selectedAmountAzn) < 0.0001) btn.classList.add('active');
 btn.addEventListener('click', () => {
 selectedAmountAzn = azn;
 syncManualFromSelected();
 syncActivePackageFromAzn();
 });
 });

 manualAmountInput.addEventListener('input', () => {
 const displayedAmount = toNum(manualAmountInput.value);
 if (!displayedAmount || displayedAmount <= 0) return;
 selectedAmountAzn = Number(aznFromDisplayed(displayedAmount).toFixed(2));
 syncActivePackageFromAzn();
 });

 window.addEventListener('azpin:currency-change', (e) => {
 if (e && e.detail && e.detail.rates) fxRates = e.detail.rates;
 if (paymentMode === 'tr') {
 updatePackageLabels();
 syncManualFromSelected();
 }
 });

 openBtn.addEventListener('click', () => {
 const selectedCurrency = String((document.getElementById('currencySelector') || {}).value || 'AZN').toUpperCase();
 setPaymentMode(selectedCurrency === 'TRY' ? 'tr' : 'c2c');
 modal.classList.add('show');
 });
 if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('show'));
 modal.addEventListener('click', (e) => {
 if (e.target === modal) modal.classList.remove('show');
 });

 submitBtn.addEventListener('click', async () => {
 const sender = (senderInput.value || '').trim();
 const receipt = receiptInput.files[0];
 const displayedAmount = toNum(manualAmountInput.value);
 const amountAzn = Number(aznFromDisplayed(displayedAmount).toFixed(2));
 if (!displayedAmount || displayedAmount <= 0 || !amountAzn || amountAzn <= 0 || !sender || !receipt) {
 Toastify({ text: "Məbləğ, Ad Soyad və dekont mütləqdir.", backgroundColor: "#ef4444" }).showToast();
 return;
 }

 const fd = new FormData();
 fd.append('amount', String(amountAzn));
 fd.append('sender_name', sender);
 fd.append('payment_method', paymentMode === 'tr' ? 'IBAN Transfer' : 'C2C Card Transfer');
 fd.append('receipt', receipt);

 submitBtn.disabled = true;
 try {
 const res = await fetch('/balance/topups/request', { method: 'POST', body: fd });
 const data = await res.json().catch(() => ({ success: false, error: 'Server xətası' }));
 if (data.success) {
 Toastify({ text: data.message || "Sorğu göndərildi.", backgroundColor: "#10b981" }).showToast();
 senderInput.value = '';
 receiptInput.value = '';
 syncManualFromSelected();
 modal.classList.remove('show');
 } else {
 Toastify({ text: "Xəta: " + (data.error || 'Bilinməyən xəta'), backgroundColor: "#ef4444" }).showToast();
 }
 } catch (err) {
 Toastify({ text: "Bağlantı xətası.", backgroundColor: "#ef4444" }).showToast();
 } finally {
 submitBtn.disabled = false;
 }
 });

 setPaymentMode('c2c');
 })();

 function createFloatingGlyph() {
 const glyph = document.createElement('i');
 const iconPool = ['ri-gamepad-line', 'ri-rocket-line', 'ri-flashlight-line', 'ri-fire-line'];
 glyph.className = 'floating-glyph ' + iconPool[Math.floor(Math.random() * iconPool.length)];
 glyph.style.left = Math.random() * 100 + 'vw';
 glyph.style.animationDuration = (10 + Math.random() * 8) + 's';
 glyph.style.opacity = (0.18 + Math.random() * 0.2).toFixed(2);
 glyph.style.fontSize = (20 + Math.random() * 22) + 'px';
 document.body.appendChild(glyph);
 setTimeout(() => { glyph.remove(); }, 19000);
 }
 setInterval(createFloatingGlyph, 900);
 </script>
 <style>
 .nav-balance-lite {
 display: flex;
 align-items: center;
 gap: 8px;
 background: rgba(255, 255, 255, 0.04);
 border: 1px solid rgba(255, 255, 255, 0.12);
 border-radius: 10px;
 height: 40px;
 padding: 0 10px;
 margin-right: 0;
 }
 .nav-balance-lite span {
 color: #e2e8f0;
 font-size: 13px;
 font-weight: 500;
 }
 .nav-balance-plus {
 width: 22px;
 height: 22px;
 border: 0;
 border-radius: 6px;
 background: rgba(255, 255, 255, 0.14);
 color: #f8fafc;
 display: grid;
 place-items: center;
 cursor: pointer;
 }
 .topup-modal {
 position: fixed;
 inset: 0;
 background: rgba(2, 6, 23, 0.62);
 z-index: 100000;
 display: none;
 align-items: center;
 justify-content: center;
 padding: 16px;
 }
 .topup-modal.show { display: flex; }
 .topup-modal-card {
 width: 100%;
 max-width: 480px;
 background: #fff;
 border-radius: 14px;
 padding: 16px;
 }
 .topup-head {
 display: flex;
 justify-content: space-between;
 align-items: center;
 }
 .topup-head h4 { margin: 0; font-size: 18px; font-weight: 700; }
 .topup-close { background: transparent; border: 0; font-size: 22px; }
 .topup-sub { margin: 8px 0 12px; font-size: 13px; color: #64748b; }
 .topup-mode-tabs {
 display: grid;
 grid-template-columns: 1fr 1fr;
 gap: 8px;
 margin: 10px 0 8px;
 }
 .topup-mode-btn {
 border: 1px solid #e2e8f0;
 background: #f8fafc;
 border-radius: 10px;
 padding: 8px 10px;
 font-size: 13px;
 font-weight: 700;
 color: #334155;
 }
 .topup-mode-btn.active {
 border-color: #2563eb;
 background: #eff6ff;
 color: #1d4ed8;
 }
 .topup-packages {
 display: grid;
 grid-template-columns: repeat(4, 1fr);
 gap: 8px;
 }
 .topup-package-btn {
 border: 1px solid #e2e8f0;
 background: #f8fafc;
 border-radius: 10px;
 padding: 8px 6px;
 font-size: 13px;
 font-weight: 600;
 }
 .topup-package-btn.active {
 border-color: #38bdf8;
 background: #ecfeff;
 color: #0369a1;
 }
 .topup-input-label {
 display: block;
 margin-top: 10px;
 margin-bottom: 2px;
 font-size: 12px;
 font-weight: 700;
 color: #334155;
 }
 .topup-input-hint {
 display: none;
 margin-top: 6px;
 font-size: 11px;
 color: #64748b;
 }
 .topup-c2c-box {
 margin-top: 12px;
 border: 1px dashed #cbd5e1;
 border-radius: 12px;
 padding: 10px 12px;
 background: #f8fafc;
 }
 .topup-bank-row {
 display: flex;
 justify-content: space-between;
 gap: 10px;
 font-size: 13px;
 margin: 4px 0;
 }
 .topup-bank-row span { color: #64748b; }
 .topup-bank-row strong { color: #0f172a; }
 .topup-form { margin-top: 12px; display: grid; gap: 8px; }
 .topup-input {
 width: 100%;
 border: 1px solid #e2e8f0;
 border-radius: 10px;
 padding: 10px;
 font-size: 14px;
 }
 .topup-security-note {
 margin: 10px 2px 0;
 font-size: 12px;
 color: #64748b;
 display: flex;
 align-items: center;
 gap: 6px;
 }
 @media (max-width: 768px) {
 .topup-packages { grid-template-columns: repeat(2, 1fr); }
 }
 </style>
