<!DOCTYPE html>
<html lang="az">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>
 <%= title %>
 </title>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
 rel="stylesheet">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.6.0/fonts/remixicon.css">
 <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
 <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css">
 <link rel="stylesheet" href="/css/transition.css?v=20260216-4">
 <link rel="stylesheet" href="/css/style.css?v=20260216-2">
 <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
</head>

<body>
 <div id="azpin-splash" aria-hidden="true">
 <div class="azpin-splash-inner">
 <img src="/images/comp-1_00000.png" alt="AZPINX" class="azpin-splash-logo">
 </div>
 </div>
 <% if (locals.error) { %>
 <script>
 window.addEventListener('load', () => {
 Toastify({
 text:"<%= error %>",
 duration: 3000,
 gravity:"top",
 position:"right",
 backgroundColor:"#ef4444",
 stopOnFocus: true
 }).showToast();
 });
 </script>
 <% } %>
 <% if (locals.success) { %>
 <script>
 window.addEventListener('load', () => {
 Toastify({
 text:"<%= success %>",
 duration: 3000,
 gravity:"top",
 position:"right",
 backgroundColor:"#10b981",
 stopOnFocus: true
 }).showToast();
 });
 </script>
 <% } %>
 <% if (locals.announcements && announcements.length> 0) { %>
 <div class="hub-msg-container">
 <div class="hub-msg-slider">
 <% announcements.forEach(msg=> { %>
 <div class="hub-msg-item hub-msg-<%= msg.type %>">
 <i class="ri-megaphone-line mr-2"></i>
 <strong>
 <%= msg.title %>:
 </strong>
 <span>
 <%= msg.message %>
 </span>
 </div>
 <% }) %>
 <!-- Duplicate for seamless loop if content is short -->
 <% announcements.forEach(msg=> { %>
 <div class="hub-msg-item hub-msg-<%= msg.type %>">
 <i class="ri-megaphone-line mr-2"></i>
 <strong>
 <%= msg.title %>:
 </strong>
 <span>
 <%= msg.message %>
 </span>
 </div>
 <% }) %>
 </div>
 </div>
 <% } %>
 <header>
 <div class="top-bar">
 <div class="top-bar-main">
 <a href="/" class="logo">
 <img src="/images/comp-1_00000.png" alt="AZPINX Logo" style="height: 85px;">
 </a>
 <button class="navbar-toggler topbar-toggler d-lg-none" type="button"
 data-toggle="collapse" data-target="#topbarActions"
 aria-controls="topbarActions" aria-expanded="false"
 aria-label="Toggle navigation">
 <i class="ri-menu-line"></i>
 </button>
 </div>
 <form action="/" method="GET" class="search-container">
 <i class="ri-search-line"></i>
 <input type="text" name="q" placeholder="Yüz minlərlə məhsul içində axtar..."
 value="<%= locals.searchQuery || '' %>">
 </form>
 <div class="collapse d-lg-flex topbar-actions-wrap" id="topbarActions">
 <div class="auth-buttons">
 <% if (locals.user) { %>
 <div class="nav-balance-lite">
 <span><%= Number(user.balance || 0).toFixed(2) %> ₼</span>
 <button type="button" class="nav-balance-plus" id="openTopupModal" title="Balans artır">
 <i class="ri-add-line"></i>
 </button>
 </div>

 <!-- Wishlist -->
 <a href="/wishlist" class="nav-btn" title="İstəklər">
 <i class="ri-heart-line"></i>
 </a>

 <!-- Tickets -->
 <a href="/tickets" class="nav-btn" title="Dəstək">
 <i class="ri-customer-service-2-line"></i>
 </a>

 <!-- FAQ -->
 <a href="/faq" class="nav-btn" title="FAQ">
 <i class="ri-question-line"></i>
 </a>

 <!-- Profile -->
 <a href="/profile" class="nav-btn" title="Profil: <%= user.full_name %>">
 <i class="ri-user-3-line"></i>
 </a>

 <!-- Admin Access -->
 <% if (user.role==='admin' ) { %>
 <a href="/admin" class="nav-btn" title="Admin Panel"
 style="color: #f43f5e;">
 <i class="ri-shield-star-line"></i>
 </a>
 <% } else if (user.role==='reseller' ) { %>
 <a href="/reseller" class="nav-btn" title="Bayi Paneli"
 style="color: #22c55e;">
 <i class="ri-store-3-line"></i>
 </a>
 <% } %>

 <!-- Logout -->
 <a href="/logout" class="nav-btn" title="Çıxış">
 <i class="ri-logout-box-r-line"></i>
 </a>

 <% } else { %>
 <a href="/login" class="btn btn-outline"
 style="border-color: rgba(255,255,255,0.2); color:white;">Daxil
 ol</a>
 <a href="/register" class="btn btn-primary">Qeydiyyat</a>
 <% } %>

 <!-- Cart Trigger (Always Visible or adjust as needed) -->
 <div class="nav-btn" id="cartTrigger">
 <i class="ri-shopping-cart-2-line"></i>
 <span class="cart-count">0</span>
 </div>
 </div>
 </div>
 </div>
 </header>
 <% if (locals.user) { %>
 <div class="topup-modal" id="topupModal">
 <div class="topup-modal-card">
 <div class="topup-head">
 <h4>Balans artır</h4>
 <button type="button" id="closeTopupModal" class="topup-close"><i class="ri-close-line"></i></button>
 </div>
 <p class="topup-sub">Paket seçin, C2C ödənişi edin, dekont yükləyin. Admin təsdiqdən sonra balans artırılacaq.</p>

 <div class="topup-packages" id="topupPackages">
 <% [20,40,60,80,100,120,140,160].forEach(function(pkg){ %>
 <button type="button" class="topup-package-btn" data-amount="<%= pkg %>"><%= pkg %> AZN</button>
 <% }) %>
 </div>
 <input type="number" id="topupAmountManual" class="topup-input mt-2" min="1" step="0.01" placeholder="və ya məbləği əl ilə daxil edin (AZN)">

 <div class="topup-c2c-box">
 <div class="topup-bank-row"><span>Kart</span><strong><%= settings.bank_card || '0000 0000 0000 0000' %></strong></div>
 <div class="topup-bank-row"><span>Sahib</span><strong><%= settings.bank_holder || 'AZPINX ADMIN' %></strong></div>
 <div class="topup-bank-row"><span>Bank</span><strong><%= settings.bank_name || 'BANK' %></strong></div>
 </div>
 <p class="topup-security-note"><i class="ri-shield-check-line"></i> Ödəniş məlumatları AES-256 və TLS ilə qorunan təhlükəsiz infrastrukturda emal olunur.</p>

 <div class="topup-form">
 <input type="text" id="topupSenderNameNav" class="topup-input" placeholder="Ad Soyad">
 <input type="file" id="topupReceiptNav" class="topup-input" accept="image/*">
 <button type="button" id="submitTopupNav" class="btn btn-primary btn-sm" style="width:100%;">Dekont göndər</button>
 </div>
 </div>
 </div>
 <% } %>

 <script>
 (function () {
 const openBtn = document.getElementById('openTopupModal');
 const closeBtn = document.getElementById('closeTopupModal');
 const modal = document.getElementById('topupModal');
 const packageWrap = document.getElementById('topupPackages');
 const submitBtn = document.getElementById('submitTopupNav');
 const senderInput = document.getElementById('topupSenderNameNav');
 const receiptInput = document.getElementById('topupReceiptNav');
 const manualAmountInput = document.getElementById('topupAmountManual');
 if (!openBtn || !modal || !packageWrap || !submitBtn || !senderInput || !receiptInput || !manualAmountInput) return;

 let selectedAmount = 20;
 packageWrap.querySelectorAll('.topup-package-btn').forEach((btn) => {
 if (Number(btn.dataset.amount) === selectedAmount) btn.classList.add('active');
 btn.addEventListener('click', () => {
 selectedAmount = Number(btn.dataset.amount || 0);
 manualAmountInput.value = String(selectedAmount);
 packageWrap.querySelectorAll('.topup-package-btn').forEach(b => b.classList.remove('active'));
 btn.classList.add('active');
 });
 });
 manualAmountInput.value = String(selectedAmount);

 manualAmountInput.addEventListener('input', () => {
 const amount = Number(manualAmountInput.value || 0);
 if (!amount) return;
 selectedAmount = amount;
 packageWrap.querySelectorAll('.topup-package-btn').forEach((b) => {
 b.classList.toggle('active', Number(b.dataset.amount) === amount);
 });
 });

 openBtn.addEventListener('click', () => modal.classList.add('show'));
 if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('show'));
 modal.addEventListener('click', (e) => {
 if (e.target === modal) modal.classList.remove('show');
 });

 submitBtn.addEventListener('click', async () => {
 const sender = (senderInput.value || '').trim();
 const receipt = receiptInput.files[0];
 const amount = Number(manualAmountInput.value || selectedAmount || 0);
 if (!amount || amount <= 0 || !sender || !receipt) {
 Toastify({ text: "Məbləğ, Ad Soyad və dekont mütləqdir.", backgroundColor: "#ef4444" }).showToast();
 return;
 }

 const fd = new FormData();
 fd.append('amount', String(amount));
 fd.append('sender_name', sender);
 fd.append('receipt', receipt);

 submitBtn.disabled = true;
 try {
 const res = await fetch('/balance/topups/request', { method: 'POST', body: fd });
 const data = await res.json().catch(() => ({ success: false, error: 'Server xətası' }));
 if (data.success) {
 Toastify({ text: data.message || "Sorğu göndərildi.", backgroundColor: "#10b981" }).showToast();
 senderInput.value = '';
 receiptInput.value = '';
 manualAmountInput.value = String(selectedAmount);
 modal.classList.remove('show');
 } else {
 Toastify({ text: "Xəta: " + (data.error || 'Bilinməyən xəta'), backgroundColor: "#ef4444" }).showToast();
 }
 } catch (err) {
 Toastify({ text: "Bağlantı xətası.", backgroundColor: "#ef4444" }).showToast();
 } finally {
 submitBtn.disabled = false;
 }
 });
 })();

 function createFloatingGlyph() {
 const glyph = document.createElement('i');
 const iconPool = ['ri-gamepad-line', 'ri-rocket-line', 'ri-flashlight-line', 'ri-fire-line'];
 glyph.className = 'floating-glyph ' + iconPool[Math.floor(Math.random() * iconPool.length)];
 glyph.style.left = Math.random() * 100 + 'vw';
 glyph.style.animationDuration = (10 + Math.random() * 8) + 's';
 glyph.style.opacity = (0.18 + Math.random() * 0.2).toFixed(2);
 glyph.style.fontSize = (20 + Math.random() * 22) + 'px';
 document.body.appendChild(glyph);
 setTimeout(() => { glyph.remove(); }, 19000);
 }
 setInterval(createFloatingGlyph, 900);
 </script>
 <style>
 .nav-balance-lite {
 display: flex;
 align-items: center;
 gap: 8px;
 background: #0f172a;
 border: 1px solid rgba(255, 255, 255, 0.08);
 border-radius: 12px;
 height: 44px;
 padding: 0 10px 0 14px;
 margin-right: 5px;
 }
 .nav-balance-lite span {
 color: #34d399;
 font-size: 14px;
 font-weight: 700;
 }
 .nav-balance-plus {
 width: 28px;
 height: 28px;
 border: 0;
 border-radius: 8px;
 background: #1e293b;
 color: #fff;
 display: grid;
 place-items: center;
 cursor: pointer;
 }
 .topup-modal {
 position: fixed;
 inset: 0;
 background: rgba(2, 6, 23, 0.62);
 z-index: 100000;
 display: none;
 align-items: center;
 justify-content: center;
 padding: 16px;
 }
 .topup-modal.show { display: flex; }
 .topup-modal-card {
 width: 100%;
 max-width: 480px;
 background: #fff;
 border-radius: 14px;
 padding: 16px;
 }
 .topup-head {
 display: flex;
 justify-content: space-between;
 align-items: center;
 }
 .topup-head h4 { margin: 0; font-size: 18px; font-weight: 700; }
 .topup-close { background: transparent; border: 0; font-size: 22px; }
 .topup-sub { margin: 8px 0 12px; font-size: 13px; color: #64748b; }
 .topup-packages {
 display: grid;
 grid-template-columns: repeat(4, 1fr);
 gap: 8px;
 }
 .topup-package-btn {
 border: 1px solid #e2e8f0;
 background: #f8fafc;
 border-radius: 10px;
 padding: 8px 6px;
 font-size: 13px;
 font-weight: 600;
 }
 .topup-package-btn.active {
 border-color: #38bdf8;
 background: #ecfeff;
 color: #0369a1;
 }
 .topup-c2c-box {
 margin-top: 12px;
 border: 1px dashed #cbd5e1;
 border-radius: 12px;
 padding: 10px 12px;
 background: #f8fafc;
 }
 .topup-bank-row {
 display: flex;
 justify-content: space-between;
 gap: 10px;
 font-size: 13px;
 margin: 4px 0;
 }
 .topup-bank-row span { color: #64748b; }
 .topup-bank-row strong { color: #0f172a; }
 .topup-form { margin-top: 12px; display: grid; gap: 8px; }
 .topup-input {
 width: 100%;
 border: 1px solid #e2e8f0;
 border-radius: 10px;
 padding: 10px;
 font-size: 14px;
 }
 .topup-security-note {
 margin: 10px 2px 0;
 font-size: 12px;
 color: #64748b;
 display: flex;
 align-items: center;
 gap: 6px;
 }
 @media (max-width: 768px) {
 .topup-packages { grid-template-columns: repeat(2, 1fr); }
 }
 </style>
