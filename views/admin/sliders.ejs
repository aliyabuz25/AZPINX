<%- include('header') %>

<div class="row">
  <div class="col-md-4">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">Yeni Slayder (Banner)</h3>
      </div>
      <form action="/admin/sliders/create" method="POST" enctype="multipart/form-data">
        <div class="card-body">
          <div class="form-group">
            <label>Banner Şəkli</label>
            <div class="input-group">
              <div class="custom-file">
                <input type="file" class="custom-file-input" name="image" accept="image/*" required id="sliderImageNew">
                <label class="custom-file-label" for="sliderImageNew">Fayl seçin</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Başlıq (Opsiyonel)</label>
            <input type="text" name="title" class="form-control" placeholder="Məs: Ən Yeni Oyunlar">
          </div>

          <div class="form-group">
            <label>Təsvir (Opsiyonel)</label>
            <textarea name="description" class="form-control" rows="3" placeholder="Qısa məlumat..."></textarea>
          </div>

          <div class="form-group">
            <label>Yönləndirmə Növü</label>
            <select name="destination_type" class="form-control slider-destination-type" data-prefix="new">
              <option value="home">Ana Səhifə</option>
              <option value="all_products">Bütün Məhsullar</option>
              <option value="category">Kateqoriya</option>
              <option value="faq">FAQ</option>
              <option value="terms">Qaydalar</option>
              <option value="profile">Profil</option>
              <option value="tickets">Dəstək</option>
              <option value="wishlist">İstək Siyahısı</option>
              <option value="cart">Səbət</option>
              <option value="checkout">Ödəniş</option>
              <option value="custom">Özəl Link</option>
            </select>
          </div>

          <div class="form-group d-none" id="new_category_wrap">
            <label>Kateqoriya seçin</label>
            <select name="destination_value" class="form-control">
              <% categories.forEach((cat) => { %>
              <option value="<%= cat.name %>"><%= cat.name %></option>
              <% }) %>
            </select>
          </div>

          <div class="form-group d-none" id="new_custom_wrap">
            <label>Özəl Link (URL)</label>
            <input type="text" name="link" class="form-control" placeholder="Məs: /product/12 və ya https://...">
          </div>
        </div>
        <div class="card-footer">
          <button type="submit" class="btn btn-primary btn-block">Yüklə və Əlavə et</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Mövcud Slayderlər</h3>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover">
          <thead>
            <tr>
              <th style="width: 50px">ID</th>
              <th>Şəkil</th>
              <th>Mətn</th>
              <th>Link</th>
              <th>Əməliyyatlar</th>
            </tr>
          </thead>
          <tbody>
            <% sliders.forEach(slider => { %>
            <tr>
              <td><%= slider.id %></td>
              <td>
                <img src="<%= slider.image_path %>" alt="Banner" style="height: 60px; border-radius: 4px;">
              </td>
              <td>
                <% if (slider.title) { %>
                <strong><%= slider.title %></strong><br>
                <% } %>
                <% if (slider.description) { %>
                <small class="text-muted"><%= slider.description %></small>
                <% } %>
                <% if (!slider.title && !slider.description) { %>
                <span class="text-muted italic small">Yalnız şəkil</span>
                <% } %>
              </td>
              <td><code><%= slider.link %></code></td>
              <td style="min-width: 260px;">
                <details>
                  <summary class="btn btn-sm btn-outline-primary mb-2">Düzənlə</summary>
                  <form action="/admin/sliders/update" method="POST" enctype="multipart/form-data" class="mb-2">
                    <input type="hidden" name="id" value="<%= slider.id %>">
                    <div class="form-group mb-2">
                      <input type="text" name="title" class="form-control form-control-sm" value="<%= slider.title || '' %>" placeholder="Başlıq">
                    </div>
                    <div class="form-group mb-2">
                      <textarea name="description" class="form-control form-control-sm" rows="2" placeholder="Təsvir"><%= slider.description || '' %></textarea>
                    </div>
                    <div class="form-group mb-2">
                      <label class="small mb-1">Yeni şəkil (opsional)</label>
                      <input type="file" class="form-control form-control-sm" name="image" accept="image/*">
                    </div>
                    <div class="form-group mb-2">
                      <select name="destination_type" class="form-control form-control-sm slider-destination-type" data-prefix="edit_<%= slider.id %>">
                        <option value="home" <%= slider.link === '/' ? 'selected' : '' %>>Ana Səhifə</option>
                        <option value="all_products" <%= slider.link === '/all-products' ? 'selected' : '' %>>Bütün Məhsullar</option>
                        <option value="category" <%= String(slider.link || '').startsWith('/all-products?category=') ? 'selected' : '' %>>Kateqoriya</option>
                        <option value="faq" <%= slider.link === '/faq' ? 'selected' : '' %>>FAQ</option>
                        <option value="terms" <%= slider.link === '/terms' ? 'selected' : '' %>>Qaydalar</option>
                        <option value="profile" <%= slider.link === '/profile' ? 'selected' : '' %>>Profil</option>
                        <option value="tickets" <%= slider.link === '/tickets' ? 'selected' : '' %>>Dəstək</option>
                        <option value="wishlist" <%= slider.link === '/wishlist' ? 'selected' : '' %>>İstək Siyahısı</option>
                        <option value="cart" <%= slider.link === '/cart' ? 'selected' : '' %>>Səbət</option>
                        <option value="checkout" <%= slider.link === '/checkout' ? 'selected' : '' %>>Ödəniş</option>
                        <option value="custom" <%= (!String(slider.link || '').startsWith('/all-products?category=') && !['/','/all-products','/faq','/terms','/profile','/tickets','/wishlist','/cart','/checkout'].includes(slider.link)) ? 'selected' : '' %>>Özəl Link</option>
                      </select>
                    </div>
                    <div class="form-group mb-2 <%= String(slider.link || '').startsWith('/all-products?category=') ? '' : 'd-none' %>" id="edit_<%= slider.id %>_category_wrap">
                      <select name="destination_value" class="form-control form-control-sm">
                        <% categories.forEach((cat) => { const selectedCategory = decodeURIComponent(String(slider.link || '').replace('/all-products?category=', '')); %>
                        <option value="<%= cat.name %>" <%= selectedCategory === cat.name ? 'selected' : '' %>><%= cat.name %></option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="form-group mb-2 <%= (!String(slider.link || '').startsWith('/all-products?category=') && !['/','/all-products','/faq','/terms','/profile','/tickets','/wishlist','/cart','/checkout'].includes(slider.link)) ? '' : 'd-none' %>" id="edit_<%= slider.id %>_custom_wrap">
                      <input type="text" name="link" class="form-control form-control-sm" value="<%= slider.link || '' %>" placeholder="Özəl Link">
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">Yadda saxla</button>
                  </form>
                </details>

                <form action="/admin/sliders/delete" method="POST" onsubmit="return confirm('Bu slayderi silmək istədiyinizə əminsiniz?');" style="display:inline;">
                  <input type="hidden" name="id" value="<%= slider.id %>">
                  <button type="submit" class="btn btn-sm btn-danger">
                    <i class="ri-delete-bin-line"></i> Sil
                  </button>
                </form>
              </td>
            </tr>
            <% }) %>
            <% if (!sliders.length) { %>
            <tr>
              <td colspan="5" class="text-center text-muted py-4">Slayder yoxdur.</td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleDestinationFields(prefix, selected) {
    const catWrap = document.getElementById(prefix + '_category_wrap');
    const customWrap = document.getElementById(prefix + '_custom_wrap');
    if (catWrap) catWrap.classList.toggle('d-none', selected !== 'category');
    if (customWrap) customWrap.classList.toggle('d-none', selected !== 'custom');
  }

  document.querySelectorAll('.slider-destination-type').forEach((el) => {
    const prefix = el.getAttribute('data-prefix');
    toggleDestinationFields(prefix, el.value);
    el.addEventListener('change', () => toggleDestinationFields(prefix, el.value));
  });

  const sliderImageNew = document.getElementById('sliderImageNew');
  if (sliderImageNew) {
    sliderImageNew.addEventListener('change', function (e) {
      const fileName = (e.target.files && e.target.files[0] && e.target.files[0].name) ? e.target.files[0].name : 'Fayl seçin';
      const label = e.target.nextElementSibling;
      if (label) label.innerText = fileName;
    });
  }
</script>

<%- include('footer') %>
